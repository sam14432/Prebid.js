<!-- Implements relevantSasCmd() that should be used *instead* of sas.cmd.push() -->
<script>
	(function () {
		var USE_PREBID = true;
		var PREBID_CONFIG = '//' + LOCALHOST_DOMAIN + '/foreca/prebid.js'

		window.sas = sas || {};
		sas.cmd = sas.cmd || [];

		/** If we're not using prebid, just run all Smart calls as usual */
		if(!USE_PREBID) {
			window.relevantSasCmd = function(fn) {
				sas.cmd.push(fn);
			}
			return;
		}

		/** Global settings object that will be used by Relevant's Prebid version */
		window.RELEVANT_PROGRAMMATIC_CONFIG = {
			loadGptJs: true, // Set to false if gpt.js is loaded elsewhere
			loadRelevantClientLib: true, // Set to false if relevant-client-lib.js is loaded elsewhere

			/** Callback when prebid is intialized and the Smart cmds are ready to be called */
			onInitPrebidDone: function(param) {
				param.auction.log('onInitPrebidDone after ' + (new Date() - timeoutStart) + ' ms');
				prebidInitialized = true;
				flushSasOps();
			},
		};

		/** How long time to wait *without* getting the onInitPrebidDone() callback above - until we skip prebid and calls Smart without prebid */
		var TIMEOUT_MS = 1000;

		/** Overwrites sas.cmd.push with relevantSasCmd - in case that change have not been done everywhere */
		var INJECT_SMART_CMD = true;

		var pendingSasOps = []; ///< Smart cmds that are queued until prebid is initialized *or* until we've timed out
		var prebidInitialized = false; ///< Will be set to true by the onInitPrebidDone() callback above
		var orgSasPush; // original sas.cmd.push when INJECT_SMART_CMD = true
		var timeoutStart;

		/** INJECT_SMART_CMD */
		function sasPush(fn) {
			if(orgSasPush) {
				orgSasPush.call(sas.cmd, fn);
			} else {
				sas.cmd.push(fn);
			}
		}

		/** Flush pending Smart cmds */
		function flushSasOps() {
			for(var i = 0; i < (pendingSasOps || []).length; i++) {
				sasPush(pendingSasOps[i]);
			}
			pendingSasOps = null;
		}

		/** Replacement for sas.cmd.push(), will delay calling that function until prebid is initalized (or we've timed out) */
		window.relevantSasCmd = function(fn) {
			if(prebidInitialized || RELEVANT_PROGRAMMATIC_CONFIG.prebidAborted) {
				sasPush(fn)
			} else {
				pendingSasOps.push(fn);
			}
		}

		/** Will abort attempt to use prebid and run all pending Smart cmds if Prebid has not been initialized after TIMEOUT_MS */
		timeoutStart = new Date();
		setTimeout(function() {
			if(!prebidInitialized) {
				console.warn('Aborting loading of Prebid.js after ' + TIMEOUT_MS + ' ms');
				RELEVANT_PROGRAMMATIC_CONFIG.prebidAborted = true;
				flushSasOps();
			}
		}, TIMEOUT_MS);

		if(INJECT_SMART_CMD) {
			pendingSasOps = sas.cmd.slice();
			sas.cmd = [];
			orgSasPush = sas.cmd.push;
			Object.defineProperty(sas.cmd, 'push', {
				get: function() { return relevantSasCmd; },
				set: function(orgFn) {
					orgSasPush = orgFn;
				},
			});
		}
		// Load prebid-config
		var script = document.createElement('script');
		script.src = PREBID_CONFIG;
		document.head.appendChild(script);
	})()
</script>
<script async src='//apps-cdn.relevant-digital.com/tags/my_prebid_config.js'></script>

